- gt creation:
  4 min 13 sec per image for matching
      - 75 threads for ba
      - images per bag: 6847 before remove low momemvent, 545 after
      - images per surf base map: 2969!!!
      - TODO: why is it only matching to last 1000 images in surf base map?? 
        - starts with image 2970, not continuous but in increasing number (skips some numbers), goes to image 3
        - what is asearch vs b search when finding matching tracks?? 
          - search containers, cid_to_cid map for finding matches
      - TODO: test with maxed threads, much faster matching per image?? 
          - max threads (96) (0 image speed): 6m 49 sec
          - 75 threads: 6m 20 sec 
      - TODO: change jacobian to be analytic! (AB)
      - TODO: find smaller base surf map????
        - check sizes of other gt surf maps in maps dir! what is the range? (AA)
          - 2972, similar

- update tutorial with simple loc and odom!
  - update simple localizer section!
  - add simple odometry section!

  - add tutorial for simple calibration (AACC)
  - add tutorial for simple mapping (AADD)
    - add examples package! make sure these compile!!!
      - add unit tests for these!!!!


    - update localizer!
      - add proper covariances to graph loc!
        - test!
          - use proper covariance calculation!
              - lookup correlation covariance calculation from last time! 
                  - why are timestamps off???
                    - print of timestamps, vl timestamps!!! 
                        - are these different?????
                          - yes! why???
                            - what timestamp does vl use for msg? of? 
                                vl:   vl->header.stamp = image_ptr->header.stamp;
                                of: features->header.stamp = msg->header.stamp;
                            - print image timestamps!! 
                                - of dropping a lot of messages!!!!
                        - find/use closest covariances??? 
                        - tune on vl noise, ar noise! 
          - does this fix some noise? ar bug?
      - add some vo factors to loc graph! 
        - test!
          - does this make things more stable?
            - tune noise values! (AAAA)
              - why does adding 0 smart factors look different than the previous cov version???
                  - change to not skipping measurements in vio??
                    - compare old cov method w/ and w/o skipping measurements to new one! (AAA)
                      - is new one actually better??
                      - sweep on measurement skipping!!
                        - new cov vio better with 2??? loc better with 0??
                      - sweep on num measurements??
                        - scale drift improves w/ more measurements (8 best)
                        - need to retune vl noise though, loc is worse w/ more measurements?? (for new cov method) (AAA)
                          - sweep w/ 2 spacing, 8 measurements....
                            - need to test w/ pose noise scale!!! 
                              - much smaller w/ new cov! use 1!
                                - sweep on values below this! (0.001 -> 1, log scale)
                                - resweep on num vl measurements! 
                                  - didn't change much..
                                - color gt colors by num landmarks?????
                                - resweep on vl noise scale 
                                  -unclear which is better..
                                  - why is ar pose bad? too low?
                          - sweep on num vo measurements w/ 0 spacing
                            - compare w/ num vo measurements w/ 2 spacing...
                          - test new cov version w/ inverse landmark num scaling (AAAAA)
                              - sweep on vl proj noise!
                                  - w/ and w/o inverse landmark dist scaling! 
                                  - how much can you make it match loc features???
                                      - sweep all scaling on num vl measurements per factor 
                                              - use 8-11!!!! (start with 10)
                                        - sweep on graph duration 
                                          - longer is better (use 8?)
                                        - sweep max num states 
                                            - unclear...
                                        - test adding marginals 
                                          - no marginals is better
                                        - test scaling linearly with num factors??? 
                                          - why should this work though??? (doesn't work)
                                        - sweep on num factors per measurement but don't add ar factors! 
                                          - fixes ignoring jump, but overcorrects to second ml measurement!
                                        - try adding smart factors again!!!
                                          - why was this so jerky???
                                          - tune on smart factor noise scale?? 
                                            - need to increase vl noise when add smart factors??? 
                                          - tune on measurement spacing? 
                                            - 0 better?
                                          - tune on num smart factors 
                                            - doesn't really matter
                                          - tune on num measurements 
                                            - doesn't really matter
                                          - decrease vio relatve pose cov when doing so? 
                                            - how to do this???? -> add param to pose_node_adder_model!!! 
                                                - sweep on this!!!
                                      - decrease cam noise? (same as decreasing loc proj noise..)
                                      - decrease all 
                                      - need to also increase vio relative factor noise??
                            - add imu values to extrapolation when estimating ar pose! 
                                - subscribe to extrapolated pose! use this for dock estimate!!! 
                                      - noisy!
                                  - interpolate this! add to pose interpolater!!!
                                      - still noisy!
                                    - change to using vio with imu extrapolation!! 
                                          - revert offline replay changes, update offline replay 
                                              - add imu and flight mode callbacks to graph localizer!  
                                                - copy graph vio stuff!
                                          - add ros_graph_localizer_wrapper_params! 
                                            - add imu integrator params!
                                          - test! 
                                              - retune? (not yet...)
                                          - push! 
                                            - remove feature points stuff from graph_loc, other bad stuff
                          - combine old vio pose measurements in odom interpolater, avoid overflow errors! (FFF)
                            - in pose extrapolator, graph localizer
                            - avoids issue of potential overflow if haven't seen a loc measurement in a while
                          - Add ability to pass flight mode to imu integrators!!! 
                            - uncomment flight mode stuff in offline replay, elsewhere
                            - compare docking localization w/ and w/o this!

                          - Fix relative factor/covariance failures!!! (AAAA)
                            - tune each cov model on loc proj noise!!!! 
                                - why does smaller pose noise start to become worse at some point??? 
                                  - ignoring these factors for some reason???? -> check code! 
                                - which one looks better????
                                  - how does extrapolated loc look??
                                - update confluence page!!! 
                                - tune on ar noise, other ar params! 
                                - do same tuning for other covariance model! 
                                - how fast can you make proper rel covariance model?? (AAAAA)
                                  - sweep on graph vio num factors, num measurements
                                    - why are there some outlier optimization times??? (AAAAAA)
                                      - limit iterations
                                      - limit num measurements
                                      - limit max num states!
                                  - sweep on loc duration, loc max num states
                                      - time using on robot replay!!!!!! (AAAAAAA)
                                          - time vio with num measurements, num factors, max num states
                                          - time loc with duration/max num states, num factors
                                          - get combo down to .2 secs???
                                - make temp new ros_graph_localizer_and_vio_nodelet, merge both in this!!! 
                                  - add to launch files!
                                    - make branch just with different launch files, and different rel pose covariance model!

                          - Test slower, better map matching??? 
                            - sweep on those parameters!
                              - adapt parameter sweeper to work with this!!!!!!
                              - best is 500 iterations, 2 inliear threshold!!!!!! 
                                 num_similar = 20
                                  - image in database to query!
                                    - decreasing not better....
                                 ransac_inlier_tolerance = 5
                                  - use smaller one??
                                    - 2 best????
                                    - smaller not always better!
                                 ransac_iterations = 100
                                      - why is ros pose extrapolator going crazy???
                                      - more iterations not always better!!!
                                 early_break_landmarks = 100
                                      - increasing not really better..
                                      - fewer not really better..
                                - interest point hamming distance???
                                      - decreasing not really better :/
                            DEFINE_int32(num_similar, 20,
                                         "Use in localization this many images which "
                                         "are most similar to the image to localize.");
                            DEFINE_int32(num_ransac_iterations, 1000,
                                         "Use in localization this many ransac iterations.");
                            DEFINE_int32(ransac_inlier_tolerance, 3,
                                         "Use in localization this inlier tolerance.");
                            DEFINE_int32(early_break_landmarks, 100,
                                         "Break early when we have this many landmarks during localization.");

                          - Why are there outlier VIO optimization times??????? 
                              - check old localizer online optimization times from bag!!! 
                                - try to match that with VIO + Loc optimization times!
                              - do you need to run them in the same process??? keep separate???
                                - test both????

                            - Test loc with large gap in ml factors!
                              - switch to other covariance model if first one fails???? (DDD)
                                - Test this!

                          - clang format!!!! (HHH) 
                            - (do after merge, avoid tutorial examples)

                          - Make everything happen in one process!!! (AAAAA)
                            - update launch files 
                              - test these...
                                - test with live replay! (AAA)
                                  - update script for this??
                                - test on robot! time things! (ABB)
                            - rename ros_graph_localizer_vio_nodelet to ros_graph_localizer_nodelet, remove other one??
                              - remove ros_graph_vio_nodelet?

                          - Update surf map branch!
                            - ping reuben
                            - compile and test 
                              - how to get surf map of granite table??
                              - test with iss map??

                          - Delay loc measurements? Add in batches??? (GGG)
                          - add ability to use loc map measurements when reset biases in graph vio! (BBB)
                              - subscribe to map measurements in graph vio
                              - only enable for x seconds, make a config variable for this
                                - enable for x meters instead of seconds??? How to measure this? keep track of displacement norm?
                          - test prev cov version, try to make it respond better to loc measurements! 
                            - increase vio rel pose cov
                            - decrease loc cov
                              - pose and proj!
                          - test adding smart factors, make vio rel poses in loc graph have super high noise!!!! 
                            - add imu factors somehow???
                              - copy imu preintegration factor, hardcode bias/velocity vals? 
                                - will this fail to scale biases properly though?
                              - remove vio rel pose?

    - test localizer!
      - w/o writing:
          cov time: 0.0275
      - w/ writing: 0.0272 
      - w/o lookup, w/ writing: negligable!
      - joint marginal information: 0.0269 
      - cholesky: 0.017 
      - test serializing marginals! (AAAAAA)
          - how big is this object?
          - how long does it take? 
          - also need to add key value for node...
            - (then just lookup correlated covariance using keys of each node)
            - add function to compute relative covariance given marginals and key values?
      - send marginals instead of looking up all of them????  

      - does VO graph restart when localization reset is called?? (AAA)
          - add reset to ros pose extrapolator!!!! (AAABBBB)
      - why does VIO graph go crazy after optical flow feature dropouts? (B)

      - add plotting num states to vio plotter! (AAA)
      - change plot names to have bag name in them! (AB)
      - why is integrated velocity y value inverted? But not integrated extrapolated y velocity?
      - Run offline, view ar tag pose!!
        - hwo to fix this??

      - fix drift issue! 
        - add imu bias extrapolated poses!
            - why does merge script change imu timestamp???
                - debug this!
        - download last bag from 3/19 test, look at this
            - add plot of IMU raw measurements! (AAA)
                - use vals from gnc/ekf? are these corrected?
            - also add num nodes!
                - divide by 3 for vio?
            - retune smart factor noise? camera noise? other?
            - look at feature tracks?
            - test with longer feature tracks? more feature tracks?

      - fix docking issue (AAAA)
        - compare world_T_dock in new vs old localizer!
          - run old localizer on beehive
          - print timestamps of most recent loc and ar tag pose! 
              dock time: 1710812129.70097
              latest time: 1710812128.1214
          - print pose of most recent vl pose! 
          - why is there a jump in ar vs ml pose position in plot??
            - does this exist on old version too?
                - no!
          - remove check for latest graph timestamp vs ar timestamp! (AA)
            - never going to get a closer estimate since vl msgs stop when ar turned on...
          - test w/ and w/o adding extrapolated VO data! (AB)
            - extrapolate to latest vo if latest vo not more than a second from latest dock! (AAAAA)
              - add warning if timestamp diff too large
              - add warning if extrapolation time since last loc graph pose too large
            - test w/ and w/o adding VO+IMU data? (AC)

          - print results on sweep of vl noise params? 
              - also view pdfs, which look better?

        - add ar tag pose adder!
        - don't extrapolate with vio/imu? -> maybe just imu?
            - add error if latest loc time diff is too large!!!
        - decrease ar tag factor uncertainty?

      - VIO undershooting!
        - check nav cam noise param in config?
          - sweep on cam noise + noise scale
          - sweep on imu params?
          - sweep on iterations
          - sweep on others?
            - num factors?
            - points per factor?
            - meas spacing
            - retriangulation threshold?
              - why is larger better?????? (AAAAAA)
                - is this better on other granite bags too???
                  - test!
                  - better to turn off retriangulation???? why??? (AAAA)
                      - only better for some bags :(
            - min avg dist from mean?
        - check calibration model, undistortin of images? 
          - is this accurate?
        - return imu params?
          - can you prevent undershooting?
        - check optical flow params?
          - underestimating movement?
            - check feature tracks!!! (AAAAA)
                - switch feature track drawing to spaced feature tracks! (AAA) 
                      - in offline replay and feature track adder
                      - why isn't this always working??? (AAAAA)
                - add puttext with feature point 3d norm distance from camera! (AABBBB)
                    - does this change w/ and w/o retriangulation????
            - plot acceleration values! (bias and unbias corrected!) (AAA)
            better with these values!!:
              world_accel_sigma = 0.0005
              world_accel_bias_sigma = 0.0005
    


          - add imu measurements and num values to plots!

      - fix not responding to resets!!!
          - pose extrapolator should respond???
          - check graph vio?????
          - test in sim??
          - check callbacks??

      - update bag sweep scripts, evaluation! (BBB)
        - test on iss bags!

      - update luisa's surf pr! (DD)

      - tune relative cov scales! (BBBB)
        - make params for pose node adder?

      - tune iss params? (CCC)
        - download recent bags and groundtruth (made for suyoung)
            - trim bag (remove end, test again) (AAAA)
            - tune with accel sigma and bias sigma?
              - bias_sigma good values: .0006, .00215 
              - simga values good: .0000129, .0000036
              - gyro_bias_sigma good: < .0002
              - compare to granite values....
          - find more good bags with groundtruth!! (AAAAAAA)
              - tune gyro sigma!
              - tune gyro bias sigma!
              - tune both together!
              - tune other params!
              - tune start bias sigma???
                - use bag that starts with movement!!!! 
                - retest on non movement start bag
                - add heuristic to estimate this? (AAAAAA)
                  - test old vio on bag?  (AA)
                  - add imu initializer that fuses map estimates with vio graph??? (AB)
            - download some bags, watch with replay (AA)
                - make sure they look good!
                  - try all suyoung bags.... (AA)
                  - try isaac bags? cmxx bags? (AB)
              - use several bag files?? try on different ones??
              - use groundtruth or vl poses!
              - add adding imu integrated poses in offline replay! (CC) 

     - finish loc plotting script! 
        - add num ml measurements! 

          - ar tag measurements come in too early, more recent than latest vio msg time!
              - check of timestamps, should more be in the interpolator??? 
                - how could ar measurements be more recent?
                  - add ar_msg buffer, fill if too recent (B)
                  - check ar_msg buffer when a VIO msg is received, add if recent enough!

      - test with sim! (A)
            - update rmse test! (B)
              - is orientation calculation correct???

                - fix adding too many loc projection factors! (A)
                - tune/lessen vio time! (AB)
                  - tune num factors
                  - tune factor noise
                  - tune standstill noise
                  - tune starting imu bias noise values
                  - tune max iterations
                  - reduce num factors? reduce graph size?
                - tune/lessen loc time! (AA)
                  - reduce graph duration
                  - limit num projection factors

                - update relative covariance in pose_with_covariance_interpolator! (AAAA)
 
            
          - why is astrobee shaking?
            - fix bias estimation
              - should be zero???
              - print initialized value (AA)
              - change params so it is less likely to change (AB)
                  - does this fix issue?

          - update pose extrapolator using extrapolation method from world_T_dock calculation
            - should be more efficient....
          - update mlp launch to use different manager for vio nodelet!
          - limit projection factors??? (A)
          - update flight mode stuff

      - test on robot! (C)

      - handle flight mode changes!
        - add support to vio stuff? others?

        - issue with odom_interpolator growing too large??? Add warning in code in pose extrapolator, pose node adder model, ros_graph_localizer_wrapper? (D)
                - add new class with these! RollingPoseInterpolator! (D)
                    - pass max buffer size
                    - keep rolling estimate
                        - just multiplies poses since last received pose!!
                    - if interpolate fails, try to subtract recent estimates still in buffer from rolling estimate so timestamps match!
                    - update everything to use this!
                      - add tests!!!!

      - tune factor covariances!
        - lessen ml factor val! (B)
          - responds too quickly to these...
        - tune max num ml factors!
          - no limit currently?
      - tune vio relative pose covariance based on duration???? (C)

      - add tuning scripts!
        - sweeps vs gt, tune variables!

    - finish plot vio script! 
            - add initilizing first vio value using groundtruth value! 
              - why is first pose start way off??
                - print adjusted pose positions! (AAA)
            
            - add integrated imu values??? (C)

            - add plotting num features! (D)
              - how to get num detected features???

            - add plotting acceleration values? (these come from imu messages....) (E)
              - bias corrected? raw?
            - add plotting angular acceleration values! (F)
              - bias corrected? raw?
 
    - add comments!
    - rename pose node adder to relative pose node adder??
      - update comments/readme/test/documentation?
    - update readme!

- add regression tests?

- update nodes interface!
  - remove or update closestnode, lowerandupperboundnodes, oldnodes
      - remove or return timestamped nodes! (no one uses these...)

- standstill factors added using all timestamps (AB)
  - should only spaced ones be used? adds more keys at timestamps between vo stamps!

- dont add successive points in smart factors that are too close together

offline replay:
  - allow for vio msg delay? run vio first, buffer vio msgs, then run graph loc?

 - add pose_extrapolator package?

  unit tests:
	ros_pose_extrapolator: update existing tests
        ros_graph_vio: imu bias initializatoin? state changes? etc?
        graph_vio: standstill code? others?
        graph_localizer: system tests?
    - add test for avoid getting covariance for first node in newly slid window if it hasn't been included in optiization yet
    - add test in base class optimizer for accessing invalid covariance for key that hasn't been optimized!
    - add test in sliding window optimizer for removing old measurements from cumulative factors!
    - add test in sliding window optimizer for removing factors with old measurements!
    - add test to remove nodes using key vector! make sure this works! (AC)


  - graph vio:
    - add better way of getting relative covariance??
	- improve pose interpolator covariance calcualtion (relative and interpolated?)
	- others?

  ros_pose_extrapolator:
    - improve covariances!! use loc covariance! use relative covariance!

  - add sanity checkers to loc!
    - drift wrt vl measurements

  - ros_graph_vio_wrapper:
    - add rest of opt stats to graph_vio

  - ros graph vio nodelet:
    - TODO: only publish states message if optimization has occured again!
        - add indicator for this in graph optimizer? last optimize time? optimize count?

  - ros graph loc nodelet:
    - add rest of opt stats to graph loc message in ros_Graph_loc_wraper!

  isam2 optimizer issues!
    - need to account for values removed when sliding window!
      - since these have keys, just check for removed keys!
    - need to account for factors removed when sliding window!
      (i.e. smart factors!)
        - since these are pts, just make sets of ptr values and check for new and removed ones!!!

  - add ordering back to sliding window optimizer now that window is slid after optimization!

  - TODO: implement others!

- TODO: how to access opt iterations????

- send pose/cov history from vio, add all poses/covs in pose node (update old values) (C)
  - add support for this in timestamped_set? (updating old values)

- how to add a second measurement to combined nav node update model????? (AE)
  - why is this needed???
    - fan rate!!!!!!
  - add to imu measurement???
- move serialization from graph_vio/loc to respective packages??
- initialize vio graph with identity pose, set fixed!!!
    - is this actually necessary? graph vio in AstroLoc worked fine...
 - rename pimpredict in other packages to extrapolate 
  - tools: loc rvz plugins, imu bias tester
